!function(e){"use strict";function t(t,i){return e.extend(!0,{},i,t.data())}function i(e){var t=e.split(":"),i=3600*Number(t[0]),l=60*Number(t[1]);return i+l}function l(e){var t=Math.floor(e/3600),i=e%3600/60;return a(t)+":"+a(i)}function a(e){return("0"+e).substr(-2)}function n(e,t){var a=e/(v.timetable.cellHeight+1)*v.timetable.timeInterval+i(v.timetable.startTime),n=t/(v.timetable.cellHeight+1)*v.timetable.timeInterval+a;return{start:a,end:n,startTime:l(a),endTime:l(n)}}function d(e,t){switch(!0){case t.start<=e.start&&t.end>e.start:case t.start<e.end&&t.end>=e.end:case t.start>=e.start&&t.end<=e.end:return!0;default:return!1}}function s(e,t){e.find("time.start").text(t.startTime),e.find("time.end").text(t.endTime)}function r(){var t=v.timetable.cellHeight+1;return{handles:"n,s",grid:[v.timetable.cellWidth,t],containment:"parent",start:function(e,t){},resize:function(t,i){var l=e(this),a=n(l.position().top,l.height());s(l,a)},stop:function(t,i){var l=!1,a=e(this),r=n(a.position().top,a.height());v.timetable.eventConflictAllow||a.siblings("div.event").each(function(t,i){var o=e(i),c=n(o.position().top,o.height());if(d(r,c)){l=!0,a.css("height",a.data("ui-resizable").originalSize.height).css("top",a.data("ui-resizable").originalPosition.top);var m=n(a.data("ui-resizable").originalPosition.top,a.data("ui-resizable").originalSize.height);return s(a,m),void(v.event.conflict&&v.event.conflict())}}),l||(s(a,r),a.data({top:a.position().top,start:r.start,end:r.end}),v.event.resize&&v.event.resize(t,i,r))}}}function o(){var t=v.timetable.cellHeight+1;return{axis:"y",grid:[v.timetable.cellWidth,t],containment:"parent",start:function(e,t){},drag:function(t,i){var l=e(this),a=n(l.position().top,l.height());s(l,a)},stop:function(t,i){var a=e(this),r=n(a.position().top,a.height()),o=!1;v.timetable.eventConflictAllow||e(this).siblings("div.event").each(function(t,i){var c=e(i),m=n(c.position().top,c.height());return d(r,m)?(s(a,{startTime:l(a.data("start")),endTime:l(a.data("end"))}),a.css("top",a.data("top")),o=!0,void(v.event.conflict&&v.event.conflict())):void 0}),o||(s(a,r),a.data({top:a.position().top,start:r.start,end:r.end}),v.event.drag&&v.event.drag(t,i,r))}}}var v=null,c={init:function(i){var l=e.extend(!0,{timetable:{startTime:"07:20",endTime:"21:50",timeInterval:600,cellHeight:20,timeField:!0,cellWidth:180,sortableColumn:!0,eventConflictAllow:!1},schedule:{data:{}},event:{resize:null,drag:null,sort:null,rangeSelection:null,conflict:null}},i);return this.each(function(){var i=e(this);i.addClass("timetable"),v=t(i,l);var a=new m(i,v);v.timetable.timeField&&a.buildTimeField(),e.each(a.settings.schedule.data,function(t,i){a.buildColumn(i),e.each(i.event,function(e,t){a.addEvent(i.id,t)})}),a.event(),i.data("plugin_timetable",a)})}};e.fn.timetable=function(t){return c[t]?c[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.timetable"):c.init.apply(this,arguments)};var m=function(){var t=function(e,t){this.$el=e,this.settings=t};return e.extend(t.prototype,{},{buildTimeField:function(){var e=i(v.timetable.startTime),t=i(v.timetable.endTime),a='<div class="timeField">';a+='<div class="originCell headerCells"><div style="width:'+v.timetable.cellWidth+'px;"></div></div>';for(var n=e,d=!0;t>n;){var s="";(n+v.timetable.timeInterval)%3600||(s="timeCellBorder"),a+='<div class="timeCell '+s+'" style="height:'+v.timetable.cellHeight+'px;">',d&&(a+=l(n)),a+="</div>",n+=v.timetable.timeInterval,d=!(n%3600)}a+="</div>",this.$el.append(a)},buildColumn:function(t){var l=i(v.timetable.startTime),a=i(v.timetable.endTime),n=t.id,d="",s=l;for(d+='<div class="column column'+n+'" id="item'+n+'" data-column-id="'+t.id+'" style="width:'+v.timetable.cellWidth+'px;">',d+='<div class="headCell headerCells" style="width:'+v.timetable.cellWidth+'px;"><div style="width:'+v.timetable.cellWidth+'px;">'+t.title+"</div></div>",d+='<div class="eventFrame">';a>s;)d+='<div class="cell time'+s+'" data-date="'+s+'" style="height:'+v.timetable.cellHeight+'px;"></div>',s+=v.timetable.timeInterval;d+="</div>",d+="</div>",this.$el.append(d);var r=0;this.$el.children().each(function(){r+=e(this).outerWidth()}),this.$el.css("width",r)},addEvent:function(t,l){var a=i(v.timetable.startTime),n=(i(l.startTime)-a)/v.timetable.timeInterval*(v.timetable.cellHeight+1),d=(i(l.endTime)-i(l.startTime))/v.timetable.timeInterval*(v.timetable.cellHeight+1),s="top:"+n+"px;height:"+d+"px;width:"+v.timetable.cellWidth+"px;left:0px;",c='<div class="event" style="'+s+'">';c+='<div class="contents">',c+='<div class="time"><time class="start">'+l.startTime+'</time> - <time class="end">'+l.endTime+"</time></div>",c+='<div class="text">'+l.text+"</div>",c+="</div>",c+="</div>",e(c).data({id:l.id,top:n,start:i(l.startTime),end:i(l.endTime)}).resizable(r()).draggable(o()).appendTo(this.$el.children("div.column"+t).children("div.eventFrame"))},event:function(){var t=!1,i=null,a=null;e(".timetable").on({mousedown:function(l){return t=!0,e(this).addClass("selectedCell"),i=e(this).parent("div.eventFrame").parent("div.column").data("columnId"),a=e(this).data("date"),!1},mouseup:function(i){if(t){e("div.cell").removeClass("selectedCell");var s=e(this),r=s.data("date"),o=!1;switch(!0){case a==r:case r>a:var c=a,m=r+v.timetable.timeInterval;break;case a>r:var c=r,m=a+v.timetable.timeInterval;break;default:return void(t=!1)}v.timetable.eventConflictAllow||e(this).siblings("div.event").each(function(i,l){var a=e(l),s=n(a.position().top,a.height());return d({start:c,end:m},s)?(o=!0,t=!1,void(v.event.conflict&&v.event.conflict())):void 0}),!o&&v.event.rangeSelection&&v.event.rangeSelection({startTime:l(c),endTime:l(m)})}t=!1},mouseover:function(){if(1==t)switch(e("div.column"+i+" > div.eventFrame > div.time"+e(this).data("date")).addClass("selectedCell"),!0){case a==e(this).data("date"):e("div.column"+i+" > div.eventFrame > div.time"+e(this).data("date")).prevAll().removeClass("selectedCell"),e("div.column"+i+" > div.eventFrame > div.time"+e(this).data("date")).nextAll().removeClass("selectedCell");break;case a<e(this).data("date"):e("div.column"+i+" > div > div.time"+e(this).data("date")).nextAll().removeClass("selectedCell"),e("div.column"+i+" > div > div.time"+a).prevAll().removeClass("selectedCell"),e("div.column"+i+" > div > div.time"+e(this).data("date")).prevUntil("div.time"+a).addClass("selectedCell");break;case a>e(this).data("date"):e("div.column"+i+" > div > div.time"+e(this).data("date")).prevAll().removeClass("selectedCell"),e("div.column"+i+" > div > div.time"+a).nextAll().removeClass("selectedCell"),e("div.column"+i+" > div > div.time"+e(this).data("date")).nextUntil("div.time"+a).addClass("selectedCell")}}},"div.cell"),v.timetable.sortableColumn&&this.$el.sortable({axis:"x",handle:"div.headCell",items:"div.column",update:function(e,t){v.event.sort&&v.event.sort(e,t)}});var s=e("div.headerCells").offset(),r="",o="";if(v.timetable.timeField)var c=e("div.timeField").width()+2;else var c=1;e(window).on("scroll",function(){if(r!=e(window).scrollLeft()){var t=e("div.timetable").position().left;v.timetable.timeField&&e("div.originCell").css("left",2-e(window).scrollLeft()+t),e("div.headCell").each(function(){if(v.timetable.timeField)var i=c+t+v.timetable.cellWidth*($(this).parent().index()-1)+2*$(this).parent().index();else var i=c+t+v.timetable.cellWidth*$(this).parent().index()+2*$(this).parent().index();var l=i-e(window).scrollLeft();e(this).css("left",l)})}o!=e(window).scrollTop()&&(e(window).scrollTop()>s.top?(e("div.headerCells").addClass("fixed"),e("div.headerCells").next().addClass("scrollArea")):(e("div.headerCells").removeClass("fixed"),e("div.headerCells").next().removeClass("scrollArea"))),r=e(window).scrollLeft(),o=e(window).scrollTop()})},_bind:function(e){var t=this;return function(){t[e].apply(t,arguments)}}}),t}()}(jQuery);