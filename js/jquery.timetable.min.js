!function(e){"use strict";function t(t,i){return e.extend(!0,{},i,t.data())}function i(e){var t=e.split(":"),i=3600*Number(t[0]),l=60*Number(t[1]);return i+l}function l(e){var t=Math.floor(e/3600),i=e%3600/60;return a(t)+":"+a(i)}function a(e){return("0"+e).substr(-2)}function d(e,t){var a=e/(c.timetable.cellHeight+1)*c.timetable.timeInterval+i(c.timetable.startTime),d=t/(c.timetable.cellHeight+1)*c.timetable.timeInterval+a;return{start:a,end:d,startTime:l(a),endTime:l(d)}}function n(e,t){switch(!0){case t.start<=e.start&&t.end>e.start:case t.start<e.end&&t.end>=e.end:case t.start>=e.start&&t.end<=e.end:return!0;default:return!1}}function s(e,t){e.find("time.start").text(t.startTime),e.find("time.end").text(t.endTime)}function r(){var t=c.timetable.cellHeight+1;return{handles:"n,s",grid:[c.timetable.cellWidth,t],containment:"parent",start:function(e,t){},resize:function(t,i){var l=e(this),a=d(l.position().top,l.height());s(l,a)},stop:function(t,i){var l=!1,a=e(this),r=d(a.position().top,a.height());c.timetable.scheduleConflictAllow||a.siblings("div.schedule").each(function(t,i){var o=e(i),v=d(o.position().top,o.height());if(n(r,v)){l=!0,a.css("height",a.data("ui-resizable").originalSize.height).css("top",a.data("ui-resizable").originalPosition.top);var m=d(a.data("ui-resizable").originalPosition.top,a.data("ui-resizable").originalSize.height);return s(a,m),void(c.event.conflict&&c.event.conflict())}}),l||(s(a,r),a.data({top:a.position().top,start:r.start,end:r.end}),c.event.resize&&c.event.resize(t,i,r))}}}function o(){var t=c.timetable.cellHeight+1;return{axis:"y",grid:[c.timetable.cellWidth,t],containment:"parent",start:function(e,t){},drag:function(t,i){var l=e(this),a=d(l.position().top,l.height());s(l,a)},stop:function(t,i){var a=e(this),r=d(a.position().top,a.height()),o=!1;c.timetable.scheduleConflictAllow||e(this).siblings("div.schedule").each(function(t,i){var v=e(i),m=d(v.position().top,v.height());return n(r,m)?(s(a,{startTime:l(a.data("start")),endTime:l(a.data("end"))}),a.css("top",a.data("top")),o=!0,void(c.event.conflict&&c.event.conflict())):void 0}),o||(s(a,r),a.data({top:a.position().top,start:r.start,end:r.end}),c.event.drag&&c.event.drag(t,i,r))}}}var c=null,v={init:function(i){var l=e.extend(!0,{timetable:{startTime:"07:20",endTime:"21:50",timeInterval:600,cellHeight:20,timeField:!0,cellWidth:180,sortableColumn:!0,scheduleConflictAllow:!1},schedule:{data:{}},event:{resize:null,drag:null,sort:null,rangeSelection:null,conflict:null}},i);return this.each(function(){var i=e(this);i.addClass("timetable"),c=t(i,l);var a=new m(i,c);c.timetable.timeField&&a.buildTimeField(),e.each(a.settings.schedule.data,function(t,i){a.buildColumn(i),e.each(i.event,function(e,t){a.addEvent(i.id,t)})}),a.event(),i.data("plugin_timetable",a)})}};e.fn.timetable=function(t){return v[t]?v[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.timetable"):v.init.apply(this,arguments)};var m=function(){var t=function(e,t){this.$el=e,this.settings=t};return e.extend(t.prototype,{},{buildTimeField:function(){var e=i(c.timetable.startTime),t=i(c.timetable.endTime),a='<div class="timeField">';a+='<div class="originCell headerCells"><div style="width:'+c.timetable.cellWidth+'px;"></div></div>';for(var d=e,n=!0;t>d;){var s="";(d+c.timetable.timeInterval)%3600||(s="timeCellBorder"),a+='<div class="timeCell '+s+'" style="height:'+c.timetable.cellHeight+'px;">',n&&(a+=l(d)),a+="</div>",d+=c.timetable.timeInterval,n=!(d%3600)}a+="</div>",this.$el.append(a)},buildColumn:function(t){var l=i(c.timetable.startTime),a=i(c.timetable.endTime),d=t.id,n="",s=l;for(n+='<div class="column column'+d+'" id="item'+d+'" data-column-id="'+t.id+'" style="width:'+c.timetable.cellWidth+'px;">',n+='<div class="headCell headerCells" style="width:'+c.timetable.cellWidth+'px;"><div style="width:'+c.timetable.cellWidth+'px;">'+t.title+"</div></div>",n+='<div class="scheduleFrame">';a>s;)n+='<div class="cell time'+s+'" data-date="'+s+'" style="height:'+c.timetable.cellHeight+'px;"></div>',s+=c.timetable.timeInterval;n+="</div>",n+="</div>",this.$el.append(n);var r=0;this.$el.children().each(function(){r+=e(this).outerWidth()}),this.$el.css("width",r)},addEvent:function(t,l){var a=i(c.timetable.startTime),d=(i(l.startTime)-a)/c.timetable.timeInterval*(c.timetable.cellHeight+1),n=(i(l.endTime)-i(l.startTime))/c.timetable.timeInterval*(c.timetable.cellHeight+1),s="top:"+d+"px;height:"+n+"px;width:"+c.timetable.cellWidth+"px;left:0px;",v='<div id="schedule'+l.id+'" class="schedule" style="'+s+'">';v+='<div class="contents">',v+='<div class="time"><time class="start">'+l.startTime+'</time> - <time class="end">'+l.endTime+"</time></div>",v+='<div class="text">'+l.text+"</div>",v+="</div>",v+="</div>",e(v).data({id:l.id,top:d,start:i(l.startTime),end:i(l.endTime)}).resizable(r()).draggable(o()).appendTo(this.$el.children("div.column"+t).children("div.scheduleFrame"))},event:function(){var t=!1,i=null,a=null;e(".timetable").on({mousedown:function(l){return t=!0,e(this).addClass("selectedCell"),i=e(this).parent("div.scheduleFrame").parent("div.column").data("columnId"),a=e(this).data("date"),!1},mouseup:function(i){if(t){e("div.cell").removeClass("selectedCell");var s=e(this),r=s.data("date"),o=!1;switch(!0){case a==r:case r>a:var v=a,m=r+c.timetable.timeInterval;break;case a>r:var v=r,m=a+c.timetable.timeInterval;break;default:return void(t=!1)}c.timetable.scheduleConflictAllow||e(this).siblings("div.schedule").each(function(i,l){var a=e(l),s=d(a.position().top,a.height());return n({start:v,end:m},s)?(o=!0,t=!1,void(c.event.conflict&&c.event.conflict())):void 0}),!o&&c.event.rangeSelection&&c.event.rangeSelection({startTime:l(v),endTime:l(m)})}t=!1},mouseover:function(){if(1==t)switch(e("div.column"+i+" > div.scheduleFrame > div.time"+e(this).data("date")).addClass("selectedCell"),!0){case a==e(this).data("date"):e("div.column"+i+" > div.scheduleFrame > div.time"+e(this).data("date")).prevAll().removeClass("selectedCell"),e("div.column"+i+" > div.scheduleFrame > div.time"+e(this).data("date")).nextAll().removeClass("selectedCell");break;case a<e(this).data("date"):e("div.column"+i+" > div > div.time"+e(this).data("date")).nextAll().removeClass("selectedCell"),e("div.column"+i+" > div > div.time"+a).prevAll().removeClass("selectedCell"),e("div.column"+i+" > div > div.time"+e(this).data("date")).prevUntil("div.time"+a).addClass("selectedCell");break;case a>e(this).data("date"):e("div.column"+i+" > div > div.time"+e(this).data("date")).prevAll().removeClass("selectedCell"),e("div.column"+i+" > div > div.time"+a).nextAll().removeClass("selectedCell"),e("div.column"+i+" > div > div.time"+e(this).data("date")).nextUntil("div.time"+a).addClass("selectedCell")}}},"div.cell"),c.timetable.sortableColumn&&this.$el.sortable({axis:"x",handle:"div.headCell",items:"div.column",update:function(e,t){c.event.sort&&c.event.sort(e,t)}});var s=e("div.headerCells").offset(),r="",o="";if(c.timetable.timeField)var v=e("div.timeField").width()+2;else var v=1;e(window).on("scroll",function(){if(r!=e(window).scrollLeft()){var t=e("div.timetable").position().left;c.timetable.timeField&&e("div.originCell").css("left",2-e(window).scrollLeft()+t),e("div.headCell").each(function(){if(c.timetable.timeField)var i=v+t+c.timetable.cellWidth*($(this).parent().index()-1)+2*$(this).parent().index();else var i=v+t+c.timetable.cellWidth*$(this).parent().index()+2*$(this).parent().index();var l=i-e(window).scrollLeft();e(this).css("left",l)})}o!=e(window).scrollTop()&&(e(window).scrollTop()>s.top?(e("div.headerCells").addClass("fixed"),e("div.headerCells").next().addClass("scrollArea")):(e("div.headerCells").removeClass("fixed"),e("div.headerCells").next().removeClass("scrollArea"))),r=e(window).scrollLeft(),o=e(window).scrollTop()})},_bind:function(e){var t=this;return function(){t[e].apply(t,arguments)}}}),t}()}(jQuery);